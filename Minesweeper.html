<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Minesweeper</title>
<meta name="author" content="Allan Jales">
<meta name="theme-color" content="#ffffff">
<style>

body{
}

#gamepad{
	background-color: #c0c0c0;
	width: max-content;
	padding: 15px;
	border-style: solid;
	border-color: #ffffff;
	border-right-color: #808080;
	border-bottom-color: #808080;
	border-width: 5px;
}

#table{
    border-spacing: 0px;
	border-style: solid;
	border-color: #808080;
	border-right-color: #ffffff;
	border-bottom-color: #ffffff;
	border-width: 5px;
}

.square{
	width: 40px;
	height: 40px;
	background-color: #808080;
	background-color: #c0c0c0;
	border-style: solid;
	border-color: #555555;
	border-color: #808080;
	border-width: 2px 0px 0px 2px;
	cursor: default;
	text-align: center;
	font-size: 32px;
	font-weight: bold;
	font-family: sans-serif;
}

.covered{
	width: 32px;
	height: 32px;
	border-style: solid;
	border-color: #a9a9a9;
	border-color: #ffffff;
	border-right-color: #808080;
	border-bottom-color: #808080;
	border-width: 5px;
	cursor: pointer;
}

.flagged{
	font-size: 28px;
}

</style>
</head>

<body>
<div id="gamepad">
	<table id="table" oncontextmenu="return false;">
		<tbody id="tbody">
		</tbody>
    </table>
</div>
</body>
</html>

<script>

const rows = 20;		//How many rows we should have
const cols = 15;		//How many columns we should have
const bombs = 50;	//How many bombs we should have

//Number colors
const colors = {
	1: '#0200fb',
	2: '#018005',
	3: '#fd0000',
	4: '#020080',
	5: '#830003',
	6: '#008080',
	7: '#000000',
	8: '#808080',
}

var game;			//Variable of game matrix
var map;			//Variable for temporary game matrix

//On load function
window.onload = function()
{
	//Define game as a array
	game = [];
	
	//Define game arrays as a array
	for (var i = 0; i < rows; i++)
	{
		game[i] = [];
	}
	
	//Start the game
	startGame();
}

//Start the game function
function startGame()
{
	//Define each point
	for (var i = 0; i < rows; i++)
	{
		for (var j = 0; j < cols; j++)
		{
			game[i][j] = {isCovered: true, isFlagged: false, whatHiddens: null};
		}
	}
	
	//Place bombs in the table
	placeBombs();
	
	//Count what numbers should show in each square
	bombCounterForAll();
	
	//Draw
	draw();
}

//Places bombs in the table
function placeBombs()
{
	//List of all points position in game
	var list = [];

	//List all positions only
	for (var i = 0; i < rows; i++)
	{
		for (var j = 0; j < cols; j++)
		{
			//Add to the list
			list.push({x: i, y: j})
		}
	}
	
	//For n bombs
	for (var i = 0; i < bombs; i++)
	{
		//Pick one place of the list
		var pickedIndex = Math.floor(Math.random()*list.length)
		var pickedObj = list[pickedIndex];
		
		//Define picked place as bomb
		game[pickedObj.x][pickedObj.y].whatHiddens = -1;
		
		//Removes the point position from list
		list.splice(pickedIndex, 1)
	}
}

//count how many adjacent bombs there is
function bombCounterForAll()
{
	//For each position
	for (var i = 0; i < rows; i++)
	{
		for (var j = 0; j < cols; j++)
		{
			//If is not a bomb
			if (game[i][j].whatHiddens != -1)
			{
				//Discover how many bombs there is
				game[i][j].whatHiddens = bombCounter(i, j);
			}
		}
	}
}

//count how many adjacent bombs there is
function bombCounter(x, y)
{
	//Log check postion
	//console.log('Test: ' + x.toString() + ' - ' + y.toString());
	
	//Quantity of bombs counted
	var counter = 0;
	
	//For each position around
	for (var i = -1; i <= 1; i++)
	{
		for (var j = -1; j <= 1; j++)
		{
			//If this position exists and it is not itself
			if (game[x+i] && game[x+i][y+j] && !(i == 0 && j == 0))
			{
				//Log test local position
				//console.log(i.toString() + ', ' + j.toString());
				
				//If is a bomb
				if (game[x+i][y+j].whatHiddens == -1)
				{
					//Counter increases
					counter++;
				}
			}
		}
	}
	
	//Returns how many bombs there is around
	return counter;
}

//Check if the clicked point is a bomb
function checkClickExplosion(x, y)
{
	//If there is a bomb
	if (game[x][y].whatHiddens == -1)
	{
		//Reveal table
		revealAllTable();
	}
}

//Reveals all the table
function revealAllTable(hide = false)
{
	//For each position in the table
	for (var i = 0; i < rows; i++)
	{
		for (var j = 0; j < cols; j++)
		{
			//Uncover it
			game[i][j].isCovered = hide ? true : false;
		}
	}
	
	//Redraws table
	draw();
}

//Reveals a part of the table
function revealArea(x, y)
{
	//If clicked square is a space with no bomb around
	if (game[x][y].whatHiddens == 0)
	{
		//Reveal every space
		while (revealEverySpaceAround())
		{
			//Nothing!
		}
		
		//Redraws table
		draw();
	}
}

//Revealed
function revealEverySpaceAround()
{
	//To future comparision
	var beforeMap = JSON.stringify(game);
	
	//For each position in the map
	for (var i = 0; i < rows; i++)
	{
		for (var j = 0; j < cols; j++)
		{
			//If it is a space with no bombs around
			if (game[i][j].whatHiddens == 0 && game[i][j].isCovered === false)
			{
				//Reveal around spaces
				revealAround(i, j);
			}
		}
	}
	
	//Return true if should do again
	if (beforeMap != JSON.stringify(game))
		return true;
	else
		return false;
}

//Reveal spaces around x, y
function revealAround(x, y)
{
	//For each position around
	for (var i = -1; i <= 1; i++)
	{
		for (var j = -1; j <= 1; j++)
		{
			//If this position exists and it is not itself
			if (game[x+i] && game[x+i][y+j] && !(i == 0 && j == 0))
			{
				//Reveal
				game[x+i][y+j].isCovered = false;
			}
		}
	}
}

//Draw on screen function
function draw()
{
	//Get table element
	var tbody = document.getElementById('tbody');
	
	//Delete all body
	tbody.innerHTML = ''

	//For each column
	for (var j = 0; j < cols; j++)
	{
		//Create a new row
		var row = tbody.appendChild(document.createElement('tr'));
		
		//Foreach row
		for (var i = 0; i < rows; i++)
		{
			//Set the element
			var element = document.createElement('td');
			
			//Add id to the element
			//element.id = i.toString() + '-' + j.toString();
			
			//Set position as attribute in element
			element.setAttribute('x', i);
			element.setAttribute('y', j);
			
			//Add event listener
			element.setAttribute('onClick', 		'handleLeftClick(this)');
			element.setAttribute('oncontextmenu', 	'handleRightClick(this)');
			
			//Add class to element
			element.classList.add('square');
			
			//Show or not show element
			if (game[i][j].isCovered)
			{
				//Add class .covered
				element.classList.add('covered');
				
				//If is flagged
				if (game[i][j].isFlagged == true)
				{
					//Shows F
					element.innerHTML = 'F';
					
					//Add class to element
					element.classList.add('flagged');
					
					//Change the color to red
					element.style.color = '#fd0000';
				}
			}
			else
			{
				//If is a number greater than 0
				if (game[i][j].whatHiddens > 0)
				{
					//Shows the number
					element.innerHTML = game[i][j].whatHiddens;
					
					//Change the color of number
					element.style.color = colors[game[i][j].whatHiddens];
				}
				
				//If is a bomb
				if (game[i][j].whatHiddens == -1)
				{
					//Shows B
					element.innerHTML = 'B';
				}
			}
		
			//Create the element in the row
			row.appendChild(element);
		}
	}
}

function handleLeftClick(selected)
{
	//Get Position of clicked object
	var x = selected.getAttribute('x');
	var y = selected.getAttribute('y');
	
	//If square is unflagged
	if (game[x][y].isFlagged === false && game[x][y].isCovered)
	{
		//Uncover the selected element
		game[x][y].isCovered = false;

		//Redraw whole table
		draw();
		
		//Reveal area
		revealArea(x, y);
		
		//Check if exploded
		checkClickExplosion(x, y);
	}
}

function handleRightClick(selected)
{
	//Get Position of clicked object
	var x = selected.getAttribute('x');
	var y = selected.getAttribute('y');
	
	//If square is covered
	if (game[x][y].isCovered === true)
	{
		//Uncover or discover the selected element
		game[x][y].isFlagged = game[x][y].isFlagged === false ? true : false;

		//Redraw whole table
		draw();
	}
}

</script>
